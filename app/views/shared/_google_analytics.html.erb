<%# Google Analytics - Deferred loading for performance %>
<script>
  // Initialize dataLayer and gtag immediately for event queuing
  window.dataLayer = window.dataLayer || [];
  const gtag = function() {
    dataLayer.push(arguments);
  };
  gtag('js', new Date());
  gtag('config', 'G-CN6KDZR57X');

  // Defer GTM script loading until user interaction
  (() => {
    let gaLoaded = false;

    const injectGTMScript = () => {
      if (gaLoaded || document.querySelector('script[src*="googletagmanager.com/gtag/js"]')) {
        return;
      }

      gaLoaded = true;
      const script = document.createElement('script');
      script.async = true;
      script.src = 'https://www.googletagmanager.com/gtag/js?id=G-CN6KDZR57X';

      // Handle script load errors gracefully (ad blockers, network issues, etc.)
      script.onerror = () => {
        // Silently fail - analytics is non-critical for page functionality
        if (typeof console !== 'undefined' && console.debug) {
          console.debug('GTM script failed to load (may be blocked by ad blocker or network issue)');
        }
      };

      try {
        document.head.appendChild(script);
      } catch (e) {
        // Silently fail if script injection fails
      }
    };

    // Load on first user interaction
    const interactionEvents = ['click', 'scroll', 'keydown', 'touchstart', 'mousemove'];
    const loadOnInteraction = () => {
      interactionEvents.forEach((event) => {
        document.addEventListener(event, injectGTMScript, { once: true, passive: true });
      });
    };

    // Load when idle
    const loadGTMWhenIdle = () => {
      if ('requestIdleCallback' in window) {
        requestIdleCallback(injectGTMScript, { timeout: 5000 });
      } else {
        const delay = document.readyState === 'complete' ? 3000 : 5000;
        setTimeout(injectGTMScript, delay);
      }
    };

    loadOnInteraction();

    // Fallback: load when idle if user doesn't interact
    if (document.readyState === 'complete') {
      loadGTMWhenIdle();
    } else if (document.readyState === 'interactive') {
      loadGTMWhenIdle();
    } else {
      document.addEventListener('DOMContentLoaded', loadGTMWhenIdle);
    }
  })();
</script>

