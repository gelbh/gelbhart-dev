<%
  # Extract repeated values for DRY principle
  default_meta_description = 'Personal portfolio and development projects by Tomer Gelbhart. Full-stack developer specializing in Ruby on Rails and modern web applications.'
  page_title_value = content_for?(:title) ? yield(:title) : page_title("")
  page_meta_description = content_for?(:meta_description) ? yield(:meta_description) : default_meta_description
  page_url = canonical_url
  social_image = social_image_url
  social_image_dims = social_image_dimensions
  og_type_value = og_type
  page_updated_time = content_for?(:updated_time) ? yield(:updated_time) : Time.current.iso8601
  page_keywords = content_for?(:keywords) ? yield(:keywords) : nil
%>
<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">
  <head>
    <%# Google Analytics - Optimized deferred loading %>
    <script>
      // Initialize dataLayer and gtag immediately for event queuing
      window.dataLayer = window.dataLayer || [];
      const gtag = function() {
        dataLayer.push(arguments);
      };
      gtag('js', new Date());
      gtag('config', 'G-VZ8VBVE21B');

      // Defer GTM script loading until user interaction or extended idle time
      // Reduces main thread blocking while maintaining tracking
      (() => {
        let gaLoaded = false;

        const injectGTMScript = () => {
          if (gaLoaded || document.querySelector('script[src*="googletagmanager.com/gtag/js"]')) {
            return;
          }

          gaLoaded = true;
          const script = document.createElement('script');
          script.async = true;
          script.src = 'https://www.googletagmanager.com/gtag/js?id=G-VZ8VBVE21B';
          document.head.appendChild(script);
        };

        // Load on first user interaction
        const interactionEvents = ['click', 'scroll', 'keydown', 'touchstart', 'mousemove'];
        const loadOnInteraction = () => {
          interactionEvents.forEach((event) => {
            document.addEventListener(event, injectGTMScript, { once: true, passive: true });
          });
        };

        // Load when idle (5s timeout for better performance)
        const loadGTMWhenIdle = () => {
          if ('requestIdleCallback' in window) {
            requestIdleCallback(injectGTMScript, { timeout: 5000 });
          } else {
            const delay = document.readyState === 'complete' ? 3000 : 5000;
            setTimeout(injectGTMScript, delay);
          }
        };

        loadOnInteraction();

        // Fallback: load when idle if user doesn't interact
        if (document.readyState === 'complete') {
          loadGTMWhenIdle();
        } else if (document.readyState === 'interactive') {
          loadGTMWhenIdle();
        } else {
          document.addEventListener('DOMContentLoaded', loadGTMWhenIdle);
        }
      })();
    </script>

    <%# Document Metadata %>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5">
    <title><%= page_title_value %></title>

    <%# SEO Meta Tags %>
    <meta name="description" content="<%= page_meta_description %>">
    <meta name="author" content="Tomer Gelbhart - Full-Stack Developer, MSc Computer Science Student at UCD">
    <meta name="language" content="English">
    <meta name="robots" content="index, follow">
    <% if page_keywords.present? %>
      <meta name="keywords" content="<%= page_keywords %>">
    <% end %>
    <link rel="canonical" href="<%= page_url %>">

    <%# Open Graph Meta Tags %>
    <meta property="og:type" content="<%= og_type_value %>">
    <meta property="og:locale" content="en_IE">
    <meta property="og:site_name" content="gelbhart.dev">
    <meta property="og:url" content="<%= page_url %>">
    <meta property="og:title" content="<%= page_title_value %>">
    <meta property="og:description" content="<%= page_meta_description %>">
    <meta property="og:image" content="<%= social_image %>">
    <meta property="og:image:secure_url" content="<%= social_image.gsub('http://', 'https://') %>">
    <meta property="og:image:type" content="image/png">
    <meta property="og:image:width" content="<%= social_image_dims[:width] %>">
    <meta property="og:image:height" content="<%= social_image_dims[:height] %>">
    <meta property="og:image:alt" content="Tomer Gelbhart - Full-Stack Developer Portfolio">
    <meta property="og:updated_time" content="<%= page_updated_time %>">
    <% if og_type_value == 'article' %>
      <meta property="article:author" content="Tomer Gelbhart">
    <% end %>

    <%# Twitter Card Meta Tags %>
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:url" content="<%= page_url %>">
    <meta name="twitter:title" content="<%= page_title_value %>">
    <meta name="twitter:description" content="<%= page_meta_description %>">
    <meta name="twitter:image" content="<%= social_image %>">
    <meta name="twitter:image:alt" content="Tomer Gelbhart - Full-Stack Developer Portfolio">

    <%# Additional Meta Tags %>
    <meta name="theme-color" content="#0d6efd">
    <meta name="format-detection" content="telephone=no">

    <%# Security Tags %>
    <%= csrf_meta_tags %>
    <%= csp_meta_tag %>

    <%# Favicon and App Icons %>
    <%= favicon_link_tag '/favicon.ico' %>
    <%= favicon_link_tag '/icons/favicons/favicon.svg', rel: 'icon', type: 'image/svg+xml' %>
    <%= favicon_link_tag '/icons/favicons/favicon-16x16.png', rel: 'icon', sizes: '16x16', type: 'image/png' %>
    <%= favicon_link_tag '/icons/favicons/favicon-32x32.png', rel: 'icon', sizes: '32x32', type: 'image/png' %>
    <%= favicon_link_tag '/icons/favicons/favicon-96x96.png', rel: 'icon', sizes: '96x96', type: 'image/png' %>
    <%= favicon_link_tag '/apple-touch-icon.png', rel: 'apple-touch-icon', sizes: '192x192', type: 'image/png' %>
    <meta name="apple-mobile-web-app-title" content="T. Gelbhart">
    <%= tag :link, rel: 'manifest', href: asset_path('/site.webmanifest') %>
    <meta name="msapplication-TileColor" content="#ffffff">
    <meta name="msapplication-config" content="/browserconfig.xml">

    <%# Resource Hints - Critical External Domains %>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="dns-prefetch" href="https://www.googletagmanager.com">
    <link rel="dns-prefetch" href="https://www.google-analytics.com">

    <%# Resource Hints - CDN Domains %>
    <link rel="dns-prefetch" href="https://unpkg.com">
    <link rel="dns-prefetch" href="https://cdn.jsdelivr.net">
    <link rel="dns-prefetch" href="https://ga.jspm.io">
    <link rel="dns-prefetch" href="https://esm.sh">
    <%# Resource Hints - Page-Specific (NASA Exoplanet Explorer) %>
    <% if request.path == '/projects/nasa-exoplanet-explorer' %>
      <link rel="preconnect" href="https://nasa-exoplanet-explorer.vercel.app">
      <link rel="dns-prefetch" href="https://nasa-exoplanet-explorer.onrender.com">
    <% end %>

    <%# Fonts - Async Loading to Prevent Render Blocking %>
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;600;700;800&display=swap" rel="stylesheet" media="print" onload="this.media='all'">
    <noscript>
      <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    </noscript>

    <%# Icon Fonts %>
    <%# Boxicons subset is now included in application.css (only used icons) %>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/lipis/flag-icons@7.2.3/css/flag-icons.min.css">

    <%# Structured Data (JSON-LD) for SEO and AI-driven search optimization %>
    <%= render_structured_data(person_structured_data) %>
    <%= render_structured_data(website_structured_data) %>
    <%= render_structured_data(organization_structured_data) %>
    <%# WebPage structured data for current page %>
    <% webpage_data = webpage_structured_data(
      name: page_title_value,
      url: page_url,
      description: page_meta_description,
      date_published: content_for?(:date_published) ? yield(:date_published) : nil,
      date_modified: content_for?(:date_modified) ? yield(:date_modified) : nil
    ) %>
    <%= render_structured_data(webpage_data) %>
    <%# Page-specific structured data can be added via content_for :structured_data %>
    <% if content_for?(:structured_data) %>
      <%= yield(:structured_data) %>
    <% end %>

    <%# Critical CSS - Inline above-the-fold styles for faster FCP %>
    <%# Minified for performance: includes root vars, body, page-wrapper, header, container, and responsive breakpoints %>
    <style>
      :root{--si-primary:#6366f1;--si-font-sans-serif:"Manrope",sans-serif}body{font-family:var(--si-font-sans-serif);margin:0;padding:0;min-height:100vh}.page-wrapper{display:flex;flex-direction:column;min-height:100vh}.header{position:fixed;top:0;left:0;width:100%;z-index:1030;background-color:rgba(11,15,25,0.8);backdrop-filter:blur(8px);transition:background-color 0.2s ease-in-out}.container{width:100%;padding-right:1rem;padding-left:1rem;margin-right:auto;margin-left:auto}.header-logo{width:47px;height:47px;transition:transform 0.3s ease}.text-center{text-align:center}@media (min-width:992px){.container{max-width:960px}.text-lg-start{text-align:left}}
    </style>

    <%# Application Stylesheets - Async loading to prevent render blocking %>
    <%= tag.link rel: "preload", href: stylesheet_path("application"), as: "style", onload: "this.onload=null;this.rel='stylesheet'", media: "all" %>
    <noscript><%= stylesheet_link_tag "application", media: "all" %></noscript>
    <script>
      // Polyfill for async CSS loading (browsers without onload support on link tags)
      (() => {
        const links = document.querySelectorAll('link[rel="preload"][as="style"]');
        links.forEach((link) => {
          if (link.onload === null || typeof link.onload !== 'function') {
            link.rel = 'stylesheet';
          }
        });
      })();
    </script>

    <%# Expose asset_path helper for JavaScript %>
    <script>
      window.assetPath = function(path) {
        const assetPaths = {
          "cbms-json-schema.json": "<%= asset_path('cbms-json-schema.json') %>"
        };
        return assetPaths[path] || `/assets/${path}`;
      };
    </script>
    <%= javascript_importmap_tags %>
  </head>

  <body>
    <main class="page-wrapper">
      <% unless controller_name == 'errors' %>
        <%= render 'shared/header' %>
      <% end %>

      <div class="container <%= 'mt-1 py-1 min-vh-100' unless controller_name == 'errors' %>">
        <%= yield %>
      </div>

      <% unless controller_name == 'errors' %>
        <%= render 'shared/footer' %>
        <%= link_to "#top", class: "btn-scroll-top", data: { scroll: "" } do %>
          <span class="btn-scroll-top-tooltip text-muted fs-sm me-2">Top</span>
          <i class="btn-scroll-top-icon bx bx-chevron-up"></i>
        <% end %>
      <% end %>
    </main>
  </body>
</html>