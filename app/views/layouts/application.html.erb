<%
  # Extract repeated values for DRY principle
  default_meta_description = 'Personal portfolio and development projects by Tomer Gelbhart. Full-stack developer specializing in Ruby on Rails and modern web applications.'
  page_title_value = content_for?(:title) ? yield(:title) : page_title("")
  page_meta_description = content_for?(:meta_description) ? yield(:meta_description) : default_meta_description
  page_url = request.original_url
  social_image = social_image_url
  social_image_dims = social_image_dimensions
  og_type_value = og_type
  page_updated_time = content_for?(:updated_time) ? yield(:updated_time) : Time.current.iso8601
  page_keywords = content_for?(:keywords) ? yield(:keywords) : nil
%>
<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">
  <head>
    <%# Google Analytics - Deferred Loading %>
    <script>
      // Initialize dataLayer and gtag function immediately for event queuing
      window.dataLayer = window.dataLayer || [];
      function gtag() {
        dataLayer.push(arguments);
      }
      gtag('js', new Date());
      gtag('config', 'G-VZ8VBVE21B');

      // Defer loading the actual GTM script until after page becomes interactive
      // This reduces main thread blocking while maintaining tracking functionality
      (function() {
        function injectGTMScript() {
          // Prevent duplicate script injection
          if (document.querySelector('script[src*="googletagmanager.com/gtag/js"]')) {
            return;
          }

          const script = document.createElement('script');
          script.async = true;
          script.src = 'https://www.googletagmanager.com/gtag/js?id=G-VZ8VBVE21B';
          document.head.appendChild(script);
        }

        function loadGTMWhenIdle() {
          if ('requestIdleCallback' in window) {
            requestIdleCallback(injectGTMScript, { timeout: 2000 });
          } else {
            // Fallback for browsers without requestIdleCallback
            const delay = document.readyState === 'complete' ? 100 : 500;
            setTimeout(injectGTMScript, delay);
          }
        }

        // Load GTM script based on page load state
        if (document.readyState === 'complete') {
          // Page already fully loaded
          loadGTMWhenIdle();
        } else if (document.readyState === 'interactive') {
          // DOM ready
          loadGTMWhenIdle();
        } else {
          // Wait for DOMContentLoaded
          document.addEventListener('DOMContentLoaded', loadGTMWhenIdle);
        }
      })();
    </script>
    <%# Document Metadata %>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5">
    <title><%= page_title_value %></title>
    <%# SEO Meta Tags %>
    <meta name="description" content="<%= page_meta_description %>">
    <meta name="author" content="Tomer Gelbhart - Full-Stack Developer, MSc Computer Science Student at UCD">
    <meta name="language" content="English">
    <meta name="robots" content="index, follow">
    <% if page_keywords.present? %>
      <meta name="keywords" content="<%= page_keywords %>">
    <% end %>
    <link rel="canonical" href="<%= page_url %>">
    <%# Open Graph Meta Tags %>
    <meta property="og:type" content="<%= og_type_value %>">
    <meta property="og:locale" content="en_IE">
    <meta property="og:site_name" content="gelbhart.dev">
    <meta property="og:url" content="<%= page_url %>">
    <meta property="og:title" content="<%= page_title_value %>">
    <meta property="og:description" content="<%= page_meta_description %>">
    <meta property="og:image" content="<%= social_image %>">
    <meta property="og:image:secure_url" content="<%= social_image.gsub('http://', 'https://') %>">
    <meta property="og:image:type" content="image/png">
    <meta property="og:image:width" content="<%= social_image_dims[:width] %>">
    <meta property="og:image:height" content="<%= social_image_dims[:height] %>">
    <meta property="og:image:alt" content="Tomer Gelbhart - Full-Stack Developer Portfolio">
    <meta property="og:updated_time" content="<%= page_updated_time %>">
    <% if og_type_value == 'article' %>
      <meta property="article:author" content="Tomer Gelbhart">
    <% end %>
    <%# Twitter Card Meta Tags %>
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:url" content="<%= page_url %>">
    <meta name="twitter:title" content="<%= page_title_value %>">
    <meta name="twitter:description" content="<%= page_meta_description %>">
    <meta name="twitter:image" content="<%= social_image %>">
    <meta name="twitter:image:alt" content="Tomer Gelbhart - Full-Stack Developer Portfolio">
    <%# Additional Meta Tags %>
    <meta name="theme-color" content="#0d6efd">
    <meta name="format-detection" content="telephone=no">
    <%# Security Tags %>
    <%= csrf_meta_tags %>
    <%= csp_meta_tag %>
    <%# Favicon and App Icons %>
    <%= favicon_link_tag '/favicon.ico' %>
    <%= favicon_link_tag '/icons/favicons/favicon.svg', rel: 'icon', type: 'image/svg+xml' %>
    <%= favicon_link_tag '/icons/favicons/favicon-16x16.png', rel: 'icon', sizes: '16x16', type: 'image/png' %>
    <%= favicon_link_tag '/icons/favicons/favicon-32x32.png', rel: 'icon', sizes: '32x32', type: 'image/png' %>
    <%= favicon_link_tag '/icons/favicons/favicon-96x96.png', rel: 'icon', sizes: '96x96', type: 'image/png' %>
    <%= favicon_link_tag '/apple-touch-icon.png', rel: 'apple-touch-icon', sizes: '192x192', type: 'image/png' %>
    <meta name="apple-mobile-web-app-title" content="T. Gelbhart">
    <%= tag :link, rel: 'manifest', href: asset_path('/site.webmanifest') %>
    <meta name="msapplication-TileColor" content="#ffffff">
    <meta name="msapplication-config" content="/browserconfig.xml">
    <%# Resource Hints - Critical External Domains %>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="dns-prefetch" href="https://www.googletagmanager.com">
    <link rel="dns-prefetch" href="https://www.google-analytics.com">
    <%# Resource Hints - CDN Domains %>
    <link rel="dns-prefetch" href="https://unpkg.com">
    <link rel="dns-prefetch" href="https://cdn.jsdelivr.net">
    <link rel="dns-prefetch" href="https://ga.jspm.io">
    <link rel="dns-prefetch" href="https://esm.sh">
    <%# Resource Hints - Page-Specific (NASA Exoplanet Explorer) %>
    <% if request.path == '/nasa-exoplanet-explorer' %>
      <link rel="preconnect" href="https://nasa-exoplanet-explorer.vercel.app">
      <link rel="dns-prefetch" href="https://nasa-exoplanet-explorer.onrender.com">
    <% end %>
    <%# Fonts - Async Loading to Prevent Render Blocking %>
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;600;700;800&display=swap" rel="stylesheet" media="print" onload="this.media='all'">
    <noscript>
      <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    </noscript>
    <%# Icon Fonts %>
    <link href="https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/lipis/flag-icons@7.2.3/css/flag-icons.min.css">
    <%# Structured Data (JSON-LD) for SEO and AI-driven search optimization %>
    <%= render_structured_data(person_structured_data) %>
    <%= render_structured_data(website_structured_data) %>
    <%= render_structured_data(organization_structured_data) %>
    <%# WebPage structured data for current page %>
    <% webpage_data = webpage_structured_data(
      name: page_title_value,
      url: page_url,
      description: page_meta_description,
      date_published: content_for?(:date_published) ? yield(:date_published) : nil,
      date_modified: content_for?(:date_modified) ? yield(:date_modified) : nil
    ) %>
    <%= render_structured_data(webpage_data) %>
    <%# Page-specific structured data can be added via content_for :structured_data %>
    <% if content_for?(:structured_data) %>
      <%= yield(:structured_data) %>
    <% end %>
    <%# Application Stylesheets and Scripts %>
    <%= stylesheet_link_tag "application", media: "all" %>
    <%= javascript_importmap_tags %>
  </head>
  <body>
    <main class="page-wrapper">
      <% unless controller_name == 'errors' %>
        <%= render 'shared/header' %>
      <% end %>
      <div class="container <%= 'mt-1 py-1 min-vh-100' unless controller_name == 'errors' %>">
        <%= yield %>
      </div>
      <% unless controller_name == 'errors' %>
        <%= render 'shared/footer' %>
        <%= link_to "#top", class: "btn-scroll-top", data: { scroll: "" } do %>
          <span class="btn-scroll-top-tooltip text-muted fs-sm me-2">Top</span>
          <i class="btn-scroll-top-icon bx bx-chevron-up"></i>
        <% end %>
      <% end %>
    </main>
  </body>
</html>