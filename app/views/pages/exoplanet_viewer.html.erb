<% content_for :title, page_title("Exoplanet 3D Viewer") %>
<% meta_description "Explore and visualize exoplanets in 3D using NASA data. Interactive tool for discovering alien worlds with realistic procedural generation." %>

<!-- Exoplanet Viewer Page -->
<div class="exoplanet-viewer-page" data-controller="exoplanet-viewer">
  <!-- Hero Section with Gradient Background -->
  <section class="position-relative exoplanet-viewer-hero">
    <!-- Animated Gradient Background -->
    <div class="exoplanet-viewer-gradient-bg"></div>

    <div class="container py-4 position-relative zindex-5">
      <div class="row justify-content-center text-center">
        <div class="col-lg-8">
          <%= render 'shared/icon_circle', icon: 'bx-planet', color: 'primary', size: 'lg' %>
          <h1 class="display-5 mb-2 mt-3">Exoplanet 3D Viewer</h1>
          <p class="lead text-light mb-2">Interactive Space Exploration</p>
          <p class="text-light opacity-75 mb-0">
            Explore discovered exoplanets in stunning 3D visualization powered by NASA data. Experience procedurally generated worlds based on real scientific measurements.
          </p>
        </div>
      </div>
    </div>
  </section>

  <!-- Main Viewer Section -->
  <section class="exoplanet-fullscreen-viewer">
    
    <!-- Full-page 3D Canvas -->
    <div class="exoplanet-canvas-container">
      <div
        data-exoplanet-viewer-target="canvas"
        class="exoplanet-threejs-canvas"
        style="background: #000000;">
      </div>

      <!-- Loading Overlay -->
      <div 
        class="position-absolute top-50 start-50 translate-middle text-white text-center"
        data-exoplanet-viewer-target="canvasLoading">
        <div class="spinner-border mb-3" role="status">
          <span class="visually-hidden">Loading...</span>
        </div>
        <p>Initializing 3D Viewer...</p>
      </div>

      <!-- Controls Overlay -->
      <div class="exoplanet-controls-overlay">
        <div class="d-flex gap-3 align-items-center flex-wrap">
          <button class="btn btn-sm btn-outline-light" data-action="click->exoplanet-viewer#resetCamera">
            <i class="bx bx-reset"></i> Reset View
          </button>
          <button class="btn btn-sm btn-outline-light" data-action="click->exoplanet-viewer#toggleFullscreen">
            <i class="bx bx-fullscreen"></i> Fullscreen
          </button>
        </div>
      </div>

      <!-- Instructions Overlay -->
      <div class="exoplanet-instructions-overlay" data-exoplanet-viewer-target="instructions">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <strong>Controls:</strong>
          <button type="button" class="btn-close btn-close-white btn-sm" aria-label="Close" onclick="this.parentElement.parentElement.style.display='none'"></button>
        </div>
        <div><i class="bx bx-mouse"></i> Drag to rotate</div>
        <div><i class="bx bx-mouse"></i> Scroll to zoom</div>
        <div><i class="bx bx-mouse"></i> Right-click drag to pan</div>
        <div id="systemInstructions" style="display: none;" class="mt-2 pt-2 border-top border-secondary">
          <div><i class="bx bx-pointer"></i> Click planet to view details</div>
        </div>
      </div>
    </div>

    <!-- Combined Panel: Search & Information (Draggable Overlay) -->
    <div class="exoplanet-overlay-panel exoplanet-combined-panel" data-exoplanet-viewer-target="leftPanel" data-panel="combined">
      <!-- Panel Header with Drag Handle and Minimize Button -->
      <div class="exoplanet-panel-header" data-drag-handle>
        <!-- Tabs Navigation -->
        <ul class="nav nav-tabs exoplanet-panel-tabs border-0 flex-grow-1" role="tablist">
          <li class="nav-item" role="presentation">
            <button class="nav-link" id="settings-tab" data-bs-toggle="tab" data-bs-target="#settings-panel" type="button" role="tab" aria-controls="settings-panel" aria-selected="false">
              <i class="bx bx-cog me-1"></i> Settings
            </button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link active" id="search-tab" data-bs-toggle="tab" data-bs-target="#search-panel" type="button" role="tab" aria-controls="search-panel" aria-selected="true">
              <i class="bx bx-search me-1"></i> Search
            </button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link" id="info-tab" data-bs-toggle="tab" data-bs-target="#info-panel" type="button" role="tab" aria-controls="info-panel" aria-selected="false">
              <i class="bx bx-info-circle me-1"></i> Info
            </button>
          </li>
        </ul>
        
        <div class="exoplanet-panel-controls">
          <button class="btn btn-sm btn-link text-white p-0" data-action="click->exoplanet-viewer#togglePanelMinimize" data-panel-target="combined" title="Minimize Panel">
            <span class="exoplanet-minimize-icon">âˆ’</span>
          </button>
        </div>
      </div>

      <!-- Panel Content with Tabs -->
      <div class="exoplanet-panel-content">
        <div class="tab-content" id="panelTabContent">
          <!-- Settings Tab Content -->
          <div class="tab-pane fade" id="settings-panel" role="tabpanel" aria-labelledby="settings-tab">
            <div class="p-4">
              <h6 class="text-white mb-4">Visualization Settings</h6>
              
              <!-- Visual Effects Section -->
              <div class="settings-section mb-4" id="visualEffectsSection">
                <div class="d-flex align-items-center mb-3">
                  <i class="bx bx-paint text-primary me-2"></i>
                  <h6 class="mb-0 text-white-50 fs-sm text-uppercase">Visual Effects</h6>
                </div>
                
                <!-- Atmosphere Toggle -->
                <div class="form-check mb-3" id="atmosphereSetting">
                  <input 
                    class="form-check-input" 
                    type="checkbox" 
                    id="atmosphereToggleSettings"
                    data-exoplanet-viewer-target="atmosphereToggle"
                    data-action="change->exoplanet-viewer#toggleAtmospheres">
                  <label class="form-check-label text-white" for="atmosphereToggleSettings">
                    <i class="bx bx-cloud me-1"></i> Show Atmospheres
                    <small class="d-block text-white-50 mt-1">Display atmospheric halos around planets</small>
                  </label>
                </div>
                
                <!-- Star Visibility Toggle -->
                <div class="form-check mb-3">
                  <input 
                    class="form-check-input" 
                    type="checkbox" 
                    id="starVisibilityToggle"
                    checked
                    data-exoplanet-viewer-target="starVisibilityToggle"
                    data-action="change->exoplanet-viewer#toggleStarVisibility">
                  <label class="form-check-label text-white" for="starVisibilityToggle">
                    <i class="bx bx-star me-1"></i> Show Background Stars
                    <small class="d-block text-white-50 mt-1">Display starfield in background</small>
                  </label>
                </div>
                
                <!-- Planet Labels Toggle -->
                <div class="form-check mb-3" id="planetLabelsSetting">
                  <input 
                    class="form-check-input" 
                    type="checkbox" 
                    id="planetLabelsToggle"
                    data-exoplanet-viewer-target="planetLabelsToggle"
                    data-action="change->exoplanet-viewer#togglePlanetLabels">
                  <label class="form-check-label text-white" for="planetLabelsToggle">
                    <i class="bx bx-label me-1"></i> Show Planet Labels
                    <small class="d-block text-white-50 mt-1">Display planet names in system view</small>
                  </label>
                </div>
              </div>
              
              <!-- Orbital Mechanics Section -->
              <div class="settings-section mb-4" id="orbitalMechanicsSection">
                <div class="d-flex align-items-center mb-3">
                  <i class="bx bx-target-lock text-info me-2"></i>
                  <h6 class="mb-0 text-white-50 fs-sm text-uppercase">Orbital Mechanics</h6>
                </div>
                
                <!-- 3D Orbits Toggle -->
                <div class="form-check mb-3">
                  <input 
                    class="form-check-input" 
                    type="checkbox" 
                    id="orbitalInclinationToggleSettings"
                    data-exoplanet-viewer-target="orbitalInclinationToggle"
                    data-action="change->exoplanet-viewer#toggleOrbitalInclination">
                  <label class="form-check-label text-white" for="orbitalInclinationToggleSettings">
                    <i class="bx bx-shape-circle me-1"></i> 3D Orbital Inclination
                    <small class="d-block text-white-50 mt-1">Use realistic 3D orbital planes</small>
                  </label>
                </div>
                
                <!-- Orbit Lines Toggle -->
                <div class="form-check mb-3">
                  <input 
                    class="form-check-input" 
                    type="checkbox" 
                    id="orbitLinesToggle"
                    checked
                    data-exoplanet-viewer-target="orbitLinesToggle"
                    data-action="change->exoplanet-viewer#toggleOrbitLines">
                  <label class="form-check-label text-white" for="orbitLinesToggle">
                    <i class="bx bx-trip me-1"></i> Show Orbit Paths
                    <small class="d-block text-white-50 mt-1">Display orbital trajectory lines</small>
                  </label>
                </div>
                
                <!-- Orbit Speed Control -->
                <div class="mb-3">
                  <label for="orbitSpeedSliderSettings" class="form-label text-white">
                    <i class="bx bx-time me-1"></i> Orbit Animation Speed
                  </label>
                  <div class="d-flex align-items-center gap-2 mb-2">
                    <input 
                      type="range" 
                      class="form-range" 
                      id="orbitSpeedSliderSettings" 
                      min="0" 
                      max="100" 
                      value="50"
                      data-exoplanet-viewer-target="orbitSpeedSlider"
                      data-action="input->exoplanet-viewer#updateOrbitSpeed">
                    <span class="badge bg-primary" data-exoplanet-viewer-target="orbitSpeedValue" style="min-width: 60px;">60.0s</span>
                  </div>
                  <small class="text-white-50">Time for one complete orbit</small>
                </div>
              </div>
              
              <!-- Performance Section -->
              <div class="settings-section mb-4">
                <div class="d-flex align-items-center mb-3">
                  <i class="bx bx-tachometer text-warning me-2"></i>
                  <h6 class="mb-0 text-white-50 fs-sm text-uppercase">Performance</h6>
                </div>
                
                <!-- Star Density Control -->
                <div class="mb-3">
                  <label for="starDensitySlider" class="form-label text-white">
                    <i class="bx bx-star me-1"></i> Star Density
                  </label>
                  <div class="d-flex align-items-center gap-2 mb-2">
                    <input 
                      type="range" 
                      class="form-range" 
                      id="starDensitySlider" 
                      min="0" 
                      max="100" 
                      value="50"
                      data-exoplanet-viewer-target="starDensitySlider"
                      data-action="input->exoplanet-viewer#updateStarDensity">
                    <span class="badge bg-secondary" data-exoplanet-viewer-target="starDensityValue" style="min-width: 60px;">50%</span>
                  </div>
                  <small class="text-white-50">Number of background stars</small>
                </div>
                
                <!-- Quality Toggle -->
                <div class="form-check mb-3">
                  <input 
                    class="form-check-input" 
                    type="checkbox" 
                    id="highQualityToggle"
                    checked
                    data-exoplanet-viewer-target="highQualityToggle"
                    data-action="change->exoplanet-viewer#toggleHighQuality">
                  <label class="form-check-label text-white" for="highQualityToggle">
                    <i class="bx bx-sparkle me-1"></i> High Quality Rendering
                    <small class="d-block text-white-50 mt-1">Enhanced textures and effects (may reduce FPS)</small>
                  </label>
                </div>
              </div>
              
              <!-- Camera Controls Section -->
              <div class="settings-section mb-4">
                <div class="d-flex align-items-center mb-3">
                  <i class="bx bx-camera text-success me-2"></i>
                  <h6 class="mb-0 text-white-50 fs-sm text-uppercase">Camera</h6>
                </div>
                
                <!-- Camera Speed Control -->
                <div class="mb-3">
                  <label for="cameraSpeedSlider" class="form-label text-white">
                    <i class="bx bx-mouse me-1"></i> Camera Rotation Speed
                  </label>
                  <div class="d-flex align-items-center gap-2 mb-2">
                    <input 
                      type="range" 
                      class="form-range" 
                      id="cameraSpeedSlider" 
                      min="0" 
                      max="100" 
                      value="50"
                      data-exoplanet-viewer-target="cameraSpeedSlider"
                      data-action="input->exoplanet-viewer#updateCameraSpeed">
                    <span class="badge bg-success" data-exoplanet-viewer-target="cameraSpeedValue" style="min-width: 60px;">1.0x</span>
                  </div>
                  <small class="text-white-50">Mouse rotation sensitivity</small>
                </div>
                
                <!-- Auto-Rotate Toggle -->
                <div class="form-check mb-3">
                  <input 
                    class="form-check-input" 
                    type="checkbox" 
                    id="autoRotateToggle"
                    data-exoplanet-viewer-target="autoRotateToggle"
                    data-action="change->exoplanet-viewer#toggleAutoRotate">
                  <label class="form-check-label text-white" for="autoRotateToggle">
                    <i class="bx bx-rotate-right me-1"></i> Auto-Rotate Camera
                    <small class="d-block text-white-50 mt-1">Automatically rotate around objects</small>
                  </label>
                </div>
              </div>
              
              <!-- Reset Button -->
              <div class="d-grid">
                <button class="btn btn-outline-primary" data-action="click->exoplanet-viewer#resetSettings">
                  <i class="bx bx-refresh me-1"></i> Reset All Settings
                </button>
              </div>
            </div>
          </div>
          
          <!-- Search Tab Content -->
          <div class="tab-pane fade show active" id="search-panel" role="tabpanel" aria-labelledby="search-tab">
        <div class="p-4">
            <!-- Search Input -->
            <div class="mb-4">
              <input 
                type="text" 
                class="form-control" 
                placeholder="Search by name..."
                data-exoplanet-viewer-target="searchInput"
                data-action="input->exoplanet-viewer#search">
            </div>

            <!-- Filters -->
            <div class="mb-4 mt-4">
              <button class="btn btn-link text-white p-0 w-100 text-start d-flex align-items-center justify-content-between" data-action="click->exoplanet-viewer#toggleFilters">
                <h6 class="mb-0 text-white">Filters</h6>
                <i class="bx bx-chevron-down fs-5" data-exoplanet-viewer-target="filtersIcon"></i>
              </button>
              
              <div class="collapse" data-exoplanet-viewer-target="filtersSection" style="margin-top: 1rem;">
              
              <!-- Filter Mode Toggle -->
              <div class="mb-3">
                <label for="filterModeSelect" class="form-label fs-sm fw-semibold">Filter By</label>
                <select id="filterModeSelect" class="form-select" data-exoplanet-viewer-target="filterMode" data-action="change->exoplanet-viewer#changeFilterMode">
                  <option value="planets">Planets</option>
                  <option value="systems">Systems</option>
                </select>
              </div>

              <!-- Planet Filters (visible when filtering planets) -->
              <div data-exoplanet-viewer-target="planetFilters">
              
              <!-- Planet Type Filter -->
              <div class="mb-3">
                <label for="planetTypeFilter" class="form-label fs-sm fw-semibold">Planet Type</label>
                <select id="planetTypeFilter" class="form-select" data-exoplanet-viewer-target="typeFilter" data-action="change->exoplanet-viewer#applyFilters">
                  <option value="">All Types</option>
                  <option value="terrestrial">Terrestrial</option>
                  <option value="super-earth">Super-Earth</option>
                  <option value="neptune">Neptune-like</option>
                  <option value="jupiter">Jupiter-like</option>
                </select>
              </div>

              <!-- Temperature Range -->
              <div class="mb-3">
                <label for="tempMinFilter" class="form-label fs-sm fw-semibold">Temperature Range (K)</label>
                <div class="row g-2">
                  <div class="col-6">
                    <input id="tempMinFilter" type="number" class="form-control" placeholder="Min" data-exoplanet-viewer-target="tempMin">
                  </div>
                  <div class="col-6">
                    <input id="tempMaxFilter" type="number" class="form-control" placeholder="Max" data-exoplanet-viewer-target="tempMax">
                  </div>
                </div>
              </div>

              <!-- Distance Filter -->
              <div class="mb-3">
                <label for="distanceFilter" class="form-label fs-sm fw-semibold">Distance (light-years)</label>
                <input id="distanceFilter" type="number" class="form-control" placeholder="Max distance" data-exoplanet-viewer-target="distanceMax">
              </div>

              <!-- Discovery Method Filter -->
              <div class="mb-3">
                <label for="discoveryMethodFilter" class="form-label fs-sm fw-semibold">Discovery Method</label>
                <select id="discoveryMethodFilter" class="form-select" data-exoplanet-viewer-target="discoveryMethodFilter" data-action="change->exoplanet-viewer#applyFilters">
                  <option value="">All Methods</option>
                  <option value="Transit">Transit</option>
                  <option value="Radial Velocity">Radial Velocity</option>
                  <option value="Microlensing">Microlensing</option>
                  <option value="Imaging">Direct Imaging</option>
                  <option value="Astrometry">Astrometry</option>
                  <option value="Timing">Timing Variations</option>
                </select>
              </div>

              <!-- Discovery Facility Filter -->
              <div class="mb-3">
                <label for="discoveryFacilityFilter" class="form-label fs-sm fw-semibold">Telescope/Mission</label>
                <select id="discoveryFacilityFilter" class="form-select" data-exoplanet-viewer-target="discoveryFacilityFilter" data-action="change->exoplanet-viewer#applyFilters">
                  <option value="">All Telescopes</option>
                  <option value="Kepler">Kepler</option>
                  <option value="TESS">TESS</option>
                  <option value="Hubble">Hubble Space Telescope</option>
                  <option value="James Webb">James Webb Space Telescope</option>
                  <option value="La Silla">La Silla Observatory</option>
                  <option value="Keck">Keck Observatory</option>
                  <option value="Spitzer">Spitzer Space Telescope</option>
                </select>
              </div>
              
              </div>
              <!-- End Planet Filters -->
              
              <!-- System Filters (visible when filtering systems) -->
              <div data-exoplanet-viewer-target="systemFilters" style="display: none;">
              
              <!-- Minimum Number of Planets -->
              <div class="mb-3">
                <label for="minPlanetsFilter" class="form-label fs-sm fw-semibold">Minimum Planets</label>
                <input id="minPlanetsFilter" type="number" class="form-control" placeholder="Min planets" min="2" data-exoplanet-viewer-target="minPlanets">
              </div>
              
              <!-- Distance Filter (Systems) -->
              <div class="mb-3">
                <label for="systemDistanceFilter" class="form-label fs-sm fw-semibold">Distance (light-years)</label>
                <input id="systemDistanceFilter" type="number" class="form-control" placeholder="Max distance" data-exoplanet-viewer-target="systemDistanceMax">
              </div>
              
              <!-- Star Spectral Type -->
              <div class="mb-3">
                <label for="spectralTypeFilter" class="form-label fs-sm fw-semibold">Star Spectral Type</label>
                <select id="spectralTypeFilter" class="form-select" data-exoplanet-viewer-target="spectralTypeFilter">
                  <option value="">All Types</option>
                  <option value="O">O - Blue (Hot)</option>
                  <option value="B">B - Blue-White</option>
                  <option value="A">A - White</option>
                  <option value="F">F - Yellow-White</option>
                  <option value="G">G - Yellow (Sun-like)</option>
                  <option value="K">K - Orange</option>
                  <option value="M">M - Red (Cool)</option>
                </select>
              </div>
              
              </div>
              <!-- End System Filters -->

              <button class="btn btn-outline-primary w-100 mb-2" data-action="click->exoplanet-viewer#applyFilters">
                Apply Filters
              </button>
              <button class="btn btn-outline-secondary w-100" data-action="click->exoplanet-viewer#clearFilters">
                Clear All
              </button>
              </div>
            </div>

            <!-- Results List -->
            <div class="results-section">
              <button class="btn btn-link text-white p-0 w-100 text-start d-flex align-items-center justify-content-between mb-2" data-action="click->exoplanet-viewer#toggleResults">
                <h6 class="mb-0 text-white">
                  Results 
                  <span class="badge bg-secondary" data-exoplanet-viewer-target="resultCount">0</span>
                </h6>
                <i class="bx bx-chevron-down fs-5" data-exoplanet-viewer-target="resultsIcon"></i>
              </button>
              
              <div class="collapse" data-exoplanet-viewer-target="resultsSection">
                <div class="d-flex align-items-center justify-content-center py-5" data-exoplanet-viewer-target="loadingIndicator">
                  <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                  </div>
                </div>

                <div data-exoplanet-viewer-target="resultsList" class="list-group">
                  <!-- Planet results will be inserted here -->
                </div>
              </div>
            </div>
          </div>
          </div>
          
          <!-- Information Tab Content -->
          <div class="tab-pane fade" id="info-panel" role="tabpanel" aria-labelledby="info-tab">
            <div class="p-4" data-exoplanet-viewer-target="infoContent">
              <h5 class="text-white mb-3">Information</h5>
              <p class="text-white-50">
                Loading information...
              </p>
            </div>
          </div>
        </div>
      </div>
    </div>

  </section>

  <!-- About Section -->
  <section class="bg-light py-5">
    <div class="container">
      <div class="row">
        <div class="col-lg-8 mx-auto">
          <h3 class="mb-4">About This Tool</h3>
          <p class="text-muted">
            This interactive 3D visualization tool brings exoplanets to life using data from NASA's Exoplanet Archive. 
            The tool uses procedural generation to create realistic approximations of what these distant worlds might look like 
            based on their known properties such as radius, mass, temperature, and host star characteristics.
          </p>
          <p class="text-muted">
            <strong>System View:</strong> Explore entire star systems with multiple planets! Switch to System View to see 
            all planets orbiting their host star with accurate relative spacing based on their orbital parameters. 
            Compare planets within the same system and watch them orbit in real-time with animated orbital mechanics.
          </p>
          
          <div class="row g-4 mt-3">
            <div class="col-md-4">
              <div class="text-center">
                <div class="bg-primary bg-opacity-10 rounded-circle d-inline-flex align-items-center justify-content-center mb-3" style="width: 64px; height: 64px;">
                  <i class="bx bx-data fs-2 text-primary"></i>
                </div>
                <h6>NASA Data</h6>
                <p class="fs-sm text-muted mb-0">Real exoplanet data from NASA's archive</p>
              </div>
            </div>
            <div class="col-md-4">
              <div class="text-center">
                <div class="bg-success bg-opacity-10 rounded-circle d-inline-flex align-items-center justify-content-center mb-3" style="width: 64px; height: 64px;">
                  <i class="bx bx-palette fs-2 text-success"></i>
                </div>
                <h6>Procedural Generation</h6>
                <p class="fs-sm text-muted mb-0">Realistic appearance based on physics</p>
              </div>
            </div>
            <div class="col-md-4">
              <div class="text-center">
                <div class="bg-warning bg-opacity-10 rounded-circle d-inline-flex align-items-center justify-content-center mb-3" style="width: 64px; height: 64px;">
                  <i class="bx bx-cube fs-2 text-warning"></i>
                </div>
                <h6>3D Rendering</h6>
                <p class="fs-sm text-muted mb-0">Interactive Three.js visualization</p>
              </div>
            </div>
            <div class="col-md-4">
              <div class="text-center">
                <div class="bg-info bg-opacity-10 rounded-circle d-inline-flex align-items-center justify-content-center mb-3" style="width: 64px; height: 64px;">
                  <i class="bx bx-sun fs-2 text-info"></i>
                </div>
                <h6>System View</h6>
                <p class="fs-sm text-muted mb-0">Multi-planet systems with orbital mechanics</p>
              </div>
            </div>
          </div>

          <div class="alert alert-warning mt-4">
            <strong>Note:</strong> This tool creates hypothetical visualizations based on scientific data. 
            The actual appearance of exoplanets can only be confirmed through direct observation, which is not yet 
            possible for most distant worlds.
          </div>
        </div>
      </div>
    </div>
  </section>
</div>


